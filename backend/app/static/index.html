<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BirdSound - Live Vogelerkennung</title>
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 10px;
        }
        
        .header {
            background: linear-gradient(135deg, #16213e, #1a1a2e);
            padding: 15px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .header h1 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #44ff44;
            box-shadow: 0 0 10px #44ff44;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .card {
            background: #16213e;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .card h3 {
            color: #4ECDC4;
            margin-bottom: 12px;
            font-size: 1rem;
        }
        
        /* Audio Pegel */
        .level-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .level-bar {
            flex: 1;
            height: 25px;
            background: #0f0f23;
            border-radius: 12px;
            overflow: hidden;
        }
        
        #levelFill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4ECDC4, #45B7AA, #51cf66);
            border-radius: 12px;
            transition: width 0.1s ease-out;
        }
        
        #levelText {
            min-width: 50px;
            text-align: right;
            font-weight: bold;
            color: #4ECDC4;
        }
        
        /* Spektrogramm */
        #spectroCanvas {
            width: 100%;
            height: 120px;
            background: #0f0f23;
            border-radius: 8px;
        }
        
        /* Waveform */
        #waveCanvas {
            width: 100%;
            height: 80px;
            background: #0f0f23;
            border-radius: 8px;
        }
        
        /* Karte */
        #map {
            width: 100%;
            height: 250px;
            border-radius: 8px;
        }
        
        /* Erkannte V√∂gel */
        .bird-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .bird-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(78, 205, 196, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #4ECDC4;
        }
        
        .bird-name {
            font-weight: bold;
        }
        
        .bird-confidence {
            color: #4ECDC4;
            font-size: 0.9rem;
        }
        
        .bird-time {
            color: #888;
            font-size: 0.8rem;
        }
        
        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 700px) {
            .grid { grid-template-columns: 1fr; }
        }
        
        /* Record Button */
        .record-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4ECDC4, #45B7AA);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .record-btn:hover {
            transform: scale(1.02);
        }
        
        .record-btn.recording {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            animation: recordPulse 1s infinite;
        }
        
        @keyframes recordPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255,107,107,0.5); }
            50% { box-shadow: 0 0 20px 10px rgba(255,107,107,0.3); }
        }
        
        .no-birds {
            text-align: center;
            color: #666;
            padding: 30px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üê¶ BirdSound <span style="font-size: 0.6em; opacity: 0.7; font-weight: normal;">v5.3.0</span></h1>
        <div class="status">
            <div class="status-dot"></div>
            <span>LIVE</span>
        </div>
    </div>
    
    <button class="record-btn" id="recordBtn" onclick="toggleRecording()">
        üé§ Aufnahme starten
    </button>
    
    <div class="card">
        <h3>üéöÔ∏è Audio-Pegel</h3>
        <div class="level-container">
            <div class="level-bar">
                <div id="levelFill"></div>
            </div>
            <span id="levelText">0%</span>
        </div>
    </div>
    
    <div class="grid">
        <div class="card">
            <h3>üìä Spektrogramm</h3>
            <canvas id="spectroCanvas"></canvas>
        </div>
        
        <div class="card">
            <h3>„Ä∞Ô∏è Wellenform</h3>
            <canvas id="waveCanvas"></canvas>
        </div>
    </div>
    
    <div class="card">
        <h3>üó∫Ô∏è Karte - Beobachtungen</h3>
        <div id="map"></div>
    </div>
    
    <div class="card">
        <h3>üê¶ Erkannte V√∂gel</h3>
        <div class="bird-list" id="birdList">
            <div class="no-birds">Noch keine V√∂gel erkannt...<br>Starte die Aufnahme!</div>
        </div>
    </div>
    
    <script>
        // === KONFIGURATION ===
        const API_URL = window.location.origin;
        let isRecording = false;
        let animationId = null;
        let phase = 0;
        
        // === CANVAS SETUP ===
        const spectroCanvas = document.getElementById('spectroCanvas');
        const waveCanvas = document.getElementById('waveCanvas');
        let spectroCtx, waveCtx;
        
        function initCanvas() {
            // Spektrogramm
            spectroCanvas.width = spectroCanvas.offsetWidth || 300;
            spectroCanvas.height = 120;
            spectroCtx = spectroCanvas.getContext('2d');
            
            // Waveform
            waveCanvas.width = waveCanvas.offsetWidth || 300;
            waveCanvas.height = 80;
            waveCtx = waveCanvas.getContext('2d');
            
            console.log('Canvas initialisiert:', spectroCanvas.width, 'x', spectroCanvas.height);
        }
        
        // === KARTE ===
        let map;
        function initMap() {
            try {
                map = L.map('map').setView([52.52, 13.405], 10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(map);
                
                // Demo-Marker
                L.marker([52.52, 13.405]).addTo(map)
                    .bindPopup('üê¶ Amsel - 89%');
                L.marker([52.48, 13.35]).addTo(map)
                    .bindPopup('üê¶ Kohlmeise - 76%');
                    
                setTimeout(() => map.invalidateSize(), 300);
                console.log('Karte initialisiert');
            } catch (e) {
                console.error('Karten-Fehler:', e);
            }
        }
        
        // === ANIMATION ===
        function animate() {
            animationId = requestAnimationFrame(animate);
            phase += 0.08;
            
            // Simulierter Audio-Pegel
            const level = isRecording ? 
                30 + Math.sin(phase) * 20 + Math.random() * 15 :
                5 + Math.sin(phase * 0.3) * 3;
            
            updateLevel(level);
            drawSpectro(level);
            drawWave(level);
        }
        
        function updateLevel(level) {
            document.getElementById('levelFill').style.width = level + '%';
            document.getElementById('levelText').textContent = Math.round(level) + '%';
        }
        
        function drawSpectro(level) {
            if (!spectroCtx) return;
            
            // Shift nach links
            const imageData = spectroCtx.getImageData(1, 0, spectroCanvas.width - 1, spectroCanvas.height);
            spectroCtx.putImageData(imageData, 0, 0);
            
            // Neue Spalte zeichnen
            for (let y = 0; y < spectroCanvas.height; y++) {
                const freq = y / spectroCanvas.height;
                const intensity = Math.sin(phase + freq * 5) * 0.5 + 0.5;
                const amp = (level / 100) * intensity;
                
                const hue = 200 - amp * 150;
                const light = 20 + amp * 40;
                spectroCtx.fillStyle = `hsl(${hue}, 70%, ${light}%)`;
                spectroCtx.fillRect(spectroCanvas.width - 1, y, 1, 1);
            }
        }
        
        function drawWave(level) {
            if (!waveCtx) return;
            
            waveCtx.fillStyle = '#0f0f23';
            waveCtx.fillRect(0, 0, waveCanvas.width, waveCanvas.height);
            
            waveCtx.strokeStyle = '#4ECDC4';
            waveCtx.lineWidth = 2;
            waveCtx.beginPath();
            
            const centerY = waveCanvas.height / 2;
            const amplitude = (level / 100) * centerY * 0.8;
            
            for (let x = 0; x < waveCanvas.width; x++) {
                const y = centerY + Math.sin((x * 0.03) + phase) * amplitude * 
                          (1 + Math.sin(x * 0.01 + phase * 0.5) * 0.3);
                
                if (x === 0) waveCtx.moveTo(x, y);
                else waveCtx.lineTo(x, y);
            }
            
            waveCtx.stroke();
        }
        
        // === AUFNAHME ===
        function toggleRecording() {
            isRecording = !isRecording;
            const btn = document.getElementById('recordBtn');
            
            if (isRecording) {
                btn.innerHTML = '‚èπÔ∏è Aufnahme stoppen';
                btn.classList.add('recording');
                
                // Simuliere Vogelerkennung nach 3 Sekunden
                setTimeout(() => {
                    if (isRecording) addBird('Amsel', 89);
                }, 3000);
                setTimeout(() => {
                    if (isRecording) addBird('Kohlmeise', 76);
                }, 6000);
                setTimeout(() => {
                    if (isRecording) addBird('Buchfink', 65);
                }, 9000);
            } else {
                btn.innerHTML = 'üé§ Aufnahme starten';
                btn.classList.remove('recording');
            }
        }
        
        function addBird(name, confidence) {
            const list = document.getElementById('birdList');
            const nobirds = list.querySelector('.no-birds');
            if (nobirds) nobirds.remove();
            
            const time = new Date().toLocaleTimeString('de-DE');
            const item = document.createElement('div');
            item.className = 'bird-item';
            item.innerHTML = `
                <div>
                    <div class="bird-name">üê¶ ${name}</div>
                    <div class="bird-time">${time}</div>
                </div>
                <div class="bird-confidence">${confidence}%</div>
            `;
            list.insertBefore(item, list.firstChild);
            
            // Marker auf Karte
            if (map) {
                const lat = 52.4 + Math.random() * 0.3;
                const lng = 13.2 + Math.random() * 0.4;
                L.marker([lat, lng]).addTo(map)
                    .bindPopup(`üê¶ ${name} - ${confidence}%`);
            }
        }
        
        // === NATIVE APP SUPPORT ===
        window.updateNativeAudioLevel = function(level, db) {
            updateLevel(level);
        };
        
        // === INIT ===
        document.addEventListener('DOMContentLoaded', () => {
            console.log('BirdSound wird geladen...');
            initCanvas();
            initMap();
            animate();
            console.log('BirdSound bereit!');
        });
        
        // Fallback f√ºr sofortigen Start
        setTimeout(() => {
            if (!spectroCtx) {
                initCanvas();
                initMap();
                animate();
            }
        }, 500);
    </script>
</body>
</html>
